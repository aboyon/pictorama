# encoding: utf-8 
#!/usr/bin/env rake
$:.push File.expand_path("../lib", __FILE__)

require 'rubygems'
require 'fileutils'
require 'picturama'
require 'mini_magick'
require "bundler/gem_tasks"
require "rake"
require "rake/testtask"

namespace :thumbnail do

  desc "Generate thumbnail for a given folder or just a single file"
  task :generate, :source do |t, args|
    if File.directory?(args[:source]) || File.exists?(args[:source])
      size = Picturama::config['thumnail_default_size']
      album = Picturama::Album.new(:folder => args[:source])
      puts "Generating #{album.count_pictures} thumbnails for folder #{args[:source]}..."
      puts "Size: #{size}"
      unless album.has_broken_thumbnails?
        puts "WARNING: Seems that this album has all his thumbnails properly generated. There are no broken thumbs."
      end
      album.init_thumbnails
      album.pictures.each do |picture|
        unless picture.has_thumbnail?
          thumb = MiniMagick::Image.open(picture.path)
          thumb.resize "#{size}"
          thumb.format "jpg"
          thumb.write picture.thumbnail
          puts "Thumbnail generated for source #{File.basename(picture.path)}. Target destination #{File.basename(picture.thumbnail)}"
        end
      end
    else
      puts "Error => target destination #{args[:source]} does not exist"
    end
  end

end

namespace :url do
  desc "Normalize album names name for URL format"
  task :sluglify, :source do |t, args|
    albums = Picturama::albums(args[:source])
    puts "In folder #{args[:source].inspect} I'm moving..."
    albums.each do |album|
      target_folder = "#{args[:source]}/#{album.folder.to_url}"
      unless File.directory?(target_folder)
        FileUtils.mv "#{args[:source]}/#{album.folder}", "#{target_folder}"
        puts "#{album.folder.inspect} to #{album.folder.to_url.inspect}"
      end
    end
  end
end

namespace :album do
  desc "metadata handling for a given album"
  namespace :metadata do
    desc "generate metadata for an album in a given path"
    task :generate do
      puts ""
      print "Type the album path:   "
      path = STDIN.gets.chomp
      if File.directory?(path)
        puts "Title:"
        title = STDIN.gets.chomp
        unless title.nil?
          puts "Description (optional):"
          description = STDIN.gets.chomp
          puts "Author (optional):"
          author = STDIN.gets.chomp
          info = {"album" => {"title" => title, "description" => description, "author" => author}}
          File.open("#{path}/.info.yml", 'w+') {|f| f.write(info.to_yaml) }
        else
          puts "Title cannot be empty. Run the task again"  
        end
      else
        puts "Sorry but #{path.inspect} entered is not a folder. Run the task again"
      end
    end

    desc "retrieve metadata an album based on path"
    task :check do
      puts ""
      print "Type the album path:   "
      path = STDIN.gets.chomp
      info_file = "#{path}/.info.yml"
      if File.directory?(path) && File.exists?(info_file)
        data = YAML.load_file(info_file)['album']
        puts "Title: #{data['title']}"
        puts "Description: #{data['description']}"
        puts "Author: #{data['author']}"
      else
        puts "Sorry but #{path.inspect} entered is not a folder. Run the task again"
      end
    end
  end
end

task :default
